<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>

	<link rel="shortcut icon" href="img/fav.png">
	<title>Step Heaven</title>

	<!-- CSS links -->
	<link rel="stylesheet" href="css/linearicons.css">
	<link rel="stylesheet" href="css/font-awesome.min.css">
	<link rel="stylesheet" href="css/themify-icons.css">
	<link rel="stylesheet" href="css/bootstrap.css">
	<link rel="stylesheet" href="css/owl.carousel.css">
	<link rel="stylesheet" href="css/nice-select.css">
	<link rel="stylesheet" href="css/nouislider.min.css">
	<link rel="stylesheet" href="css/ion.rangeSlider.css" />
	<link rel="stylesheet" href="css/ion.rangeSlider.skinFlat.css" />
	<link rel="stylesheet" href="css/magnific-popup.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/themify-icons.css">
	<link rel="stylesheet" href="css/font-awesome.min.css">
	<link rel="stylesheet" href="css/nice-select.css">
	<link rel="stylesheet" href="css/nouislider.min.css">

	<!-- Script links -->
	<script defer src="js/vendor/jquery-2.2.4.min.js"></script>
	<script defer src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
	<script defer src="js/vendor/bootstrap.min.js"></script>
	<script defer src="js/jquery.ajaxchimp.min.js"></script>
	<script defer src="js/jquery.nice-select.min.js"></script>
	<script defer src="js/jquery.sticky.js"></script>
	<script defer src="js/nouislider.min.js"></script>
	<script defer src="js/countdown.js"></script>
	<script defer src="js/jquery.magnific-popup.min.js"></script>
	<script defer src="js/owl.carousel.min.js"></script>
	<script defer src="js/main.js"></script>

	 <!-- razor pay  -->

	 <script defer src="https://checkout.razorpay.com/v1/checkout.js"></script>

	 <!-- SweetAlert -->
	 <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

	<!-- Icon -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>

	<!-- Start Header Area -->
	<header class="header_area sticky-header">
		<div class="main_menu">
			<nav class="navbar navbar-expand-lg navbar-light main_box">
				<div class="container">
					<!-- Brand and toggle get grouped for better mobile display -->
					<a class="navbar-brand logo_h" href="/"><img src="/img/shopIcon.png" alt="img" width="100"></a>
					<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
					 aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<!-- Collect the nav links, forms, and other content for toggling -->
					<div class="collapse navbar-collapse offset" id="navbarSupportedContent">
						<ul class="nav navbar-nav menu_nav ml-auto align-items-center justify-content-center">
							<li class="nav-item active"><a class="nav-link" href="/" style="color: #ff6c00;">Home</a></li>
							<li class="nav-item">
								<a href="/shop" class="nav-link" 
								 aria-expanded="false" style="color: #ff6c00;">Shop</a>
							</li>
							<li class="nav-item"><a class="nav-link" href="/contact" style="color: #ff6c00;">Contact</a></li>
							<li class="nav-item"><a href="/cart" class="cart"><span class="ti-bag" style="font-size: 1.3rem;color: #ff6c00;"></span></a></li>
							<li class="nav-item d-none">
								<button class="search" style="border: none;outline: none;background-color: transparent;"><span class="lnr lnr-magnifier" id="search" style="font-size: 1.3rem;color: #ff6c00;"></span></button>
							</li>
							<li class="nav-item">
								<a href="/wishlist" class="nav-link" 
								 aria-expanded="false"><span class="bi bi-heart-fill" style="font-size: 1.3rem;color: #ff6c00;"></span></a>
							</li>
							<li class="nav-item">
								 <button style="font-size: 1.2rem;
							padding: 10px 15px;
							border-radius: 27px;
							border: none;
							background-image: linear-gradient(90deg, #ffba00 0%, #ff6c00 100%) !important;
							outline: none;"><a href="/orderhistory" style="color:#ffff;">Order history</a></button>
							</li>
							<li class="nav-item mx-3">
								<a href="/profile" class="nav-link"
								 aria-expanded="false"><button class="btn-primary" style="font-size: 2.5rem;border: none;outline: none; background-color: transparent;"><i class="bi bi-person-circle" style="color: #ff6c00;"></i></button></a>
							</li>
						</ul>
					</div>
				</div>
			</nav>
		</div>
		<div class="search_input" id="search_input_box">
			<div class="container">
				<form class="d-flex justify-content-between">
					<input type="text" class="form-control" id="search_input" placeholder="Search Here">
					<button type="submit" class="btn"></button>
					<span class="lnr lnr-cross" id="close_search" title="Close Search"></span>
				</form>
			</div>
		</div>
	</header>
	<!-- End Header Area -->

	<!-- Start Banner Area -->
	<section class="banner-area organic-breadcrumb">
		<div class="container">
			<div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
				<div class="col-first">
					<h1>Order History</h1>
					<nav class="d-flex align-items-center">
						<a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
						<p>Order history</p>
					</nav>
				</div>
			</div>
		</div>
	</section>
	<!-- End Banner Area -->

	<!--================Table Box Area =================-->
	<section class="login_box_area section_gap">
	<div class="container">
      <div class="row shadow py-3" style="overflow: auto;height: 600px;position: relative;">
       
		<% if(checkOut && checkOut.length > 0){ %>
			<% checkOut.forEach((details,index)=>{ %>
				<% details.cart.items.forEach((item,index)=>{ %>
				<div class="shadow rounded-4 m-3 p-3  row d-flex " style="width: 100%;height: 300px;">
					


					<div class="col-auto w-100  d-flex align-items-center justify-content-between">
						<% 
						const variant = item.product.variants.find(variant => variant?.color === item.variant?.color);
						if (variant && variant.imageUrls && variant.imageUrls.length > 0) {
						%>
							<img class="img-fluid mt-4 rounded-3" src="<%= variant?.imageUrls[0] %>" class="card-img-top" alt="Product Image" style="height: 69px;">
						<% } else { %>
							<img class="img-fluid mt-4 rounded-3" src="" class="card-img-top" alt="No Image Available">
						<% } %>
						<%if(details.orderStatus==='Pending'){%>
							<div>
						    <button class="btn btn-primary" onclick="confirmReOrder('<%=details._id%>',<%=details.totalPrice%>)">Repay</button>	
						   </div>
						<%}%>
					</div>





				   <div class="col-auto  w-100 h-50">
					<div class="p-0 d-flex align-items-center justify-content-evenly" style="line-height: 1.1;">
						<div class="col-auto w-50">
						    <h5 class=""><b><%=item?.product?.name%></b></h5>
						   <p class="">Payment Method: <b><%=details?.paymentMethod%></b> </p>
						   <p class="">quantity:<b><%=item?.quantity%></b></p>
						   <!-- <p class="">Discount: â‚¹0</p>	 -->
						</div>
						<div class="col-auto  w-50">
							<p class=""><b>Total: â‚¹ <%=details.totalPrice%></b> </p>
						<p class=""><b>Status :  <%=details.orderStatus%>  </b> </p>
						<p class=""><b>Purchased Date :  <%=new Date(details.createdAt).toDateString() %>  </b> </p>
						<a href="/orderhistory/details/<%=encodeURIComponent(details._id)%>" class="btn btn-primary mt-2" style="padding: 0.500em 10em;">Details</a>
						<button class="btn btn-success mt-2" onclick="downloadInvoice('<%=details._id%>')">invoice</button>
						</div>
						
					  </div>
				   </div>
				  </div>
				<% }) %>
		<%  })%>

		<!-- pagination -->
		<div class="d-flex w-100 justify-content-center " style="position: sticky;bottom: 0;z-index: 30;background-color: #ffff;">
			<nav aria-label="Page navigation example">
			  <ul class="pagination">
				<% if (totalPages > 1) { %>
				  <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
					<a class="page-link" href="/orderhistory?page=<%= currentPage - 1 %>" aria-label="Previous">
					  <span aria-hidden="true">&laquo;</span>
					  <span class="sr-only">Previous</span>
					</a>
				  </li>
				<% } %>
		  
				<% 
				  let startPage = Math.max(1, currentPage - 1);
				  let endPage = Math.min(startPage + 2, totalPages);
				  if (endPage - startPage < 2) startPage = Math.max(1, endPage - 2);
				%>
		  
				<% for(let i = startPage; i <= endPage; i++) { %>
				  <li class="page-item <%= i === currentPage ? 'active' : '' %>">
					<a class="page-link" href="/orderhistory?page=<%= i %>"><%= i %></a>
				  </li>
				<% } %>
		  
				<% if (totalPages > 1) { %>
				  <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
					<a class="page-link" href="/orderhistory?page=<%= currentPage + 1 %>" aria-label="Next">
					  <span aria-hidden="true">&raquo;</span>
					  <span class="sr-only">Next</span>
					</a>
				  </li>
				<% } %>
			  </ul>
			</nav>
		  </div>


		<%  }else{ %>
			<div class="w-100 align-items-center justify-content-center d-flex">
				<h1 style="color:#ff6c00">No Order Found ðŸ¥²</h1>
			</div>
		<%  }%>
        

      </div>
	  
		
	 
   </div>
  
	</section>
	<!--================End Table Box Area =================-->

	<!-- Start Footer Area -->
	<footer class="footer-area section_gap">
		<div class="container">
			<div class="row">
				<div class="col-6">
					<div class="single-footer-widget mail-chimp">
						<h6 class="mb-20">Brand</h6>
						<ul class="instafeed d-flex flex-wrap">
							<li><img src="img/i1.jpg" alt=""></li>
							<li><img src="img/i2.jpg" alt=""></li>
							<li><img src="img/i3.jpg" alt=""></li>
						</ul>
					</div>
				</div>
				<div class="col-6 d-flex justify-content-end align-content-center">
					<div class="single-footer-widget  w-50">
						<h6>Follow Us</h6>
						<p>Let us be social</p>
						<div class="footer-social d-flex align-items-center">
							<a href="#"><i class="fa fa-facebook"></i></a>
							<a href="#"><i class="fa fa-twitter"></i></a>
						</div>
					</div>
				</div>
			</div>
			<div class="footer-bottom d-flex justify-content-center align-items-center flex-wrap">
				<p class="footer-text m-0">
Copyright &copy;&nbsp;<script>document.write(new Date().getFullYear());</script> 
</p>
			</div>
		</div>
	</footer>
	<!-- End Footer Area -->

	<!-- Script for search -->
	<script>

		function downloadInvoice(orderId){
			window.location.href = `/generateInvoice/${orderId}`;
			fetch(`/generateInvoice/${orderId}`)
			.then(()=>{
				Swal.fire({
					title: 'Invoice generated',
					icon: 'success',
					showConfirmButton: false,
					timer: 1500
				})
			}).catch(err=>{
				console.log(err);
				Swal.fire({
					title: 'Error',
					text: 'Failed to generate invoice',
					icon: 'error',
					showConfirmButton: true
				})
				window.location.href = '/orderhistory';
			})
		}



        document.getElementById('search_input_table').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const rows = document.querySelectorAll('#table-body tr');
            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                let isVisible = false;
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(query)) {
                        isVisible = true;
                        break;
                    }
                }
                row.style.display = isVisible ? '' : 'none';
            });
        });


		function confirmReOrder(orderId,totalPrice) {
			// console.log(orderId,totalPrice);
			
        const amount = totalPrice
        // console.log("totalPrices >>> ",totalPrices);
        // console.log("confirmReOrder >>> ",orderId);
        Swal.fire({
            title: 'Repay this order?',
            text: 'you will be redirected to payment gateway',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, repay it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/createRazorpayOrder',{
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ amount:amount*100})
                })
                .then(response => response.json())
                .then(data => {
                    console.log("createRazorpayOrder >>> ",data);
                    if(data.success){
                        
                        const options = {
                           "key": '<%=process.env.RAZORPAY_KEY_ID%>',
                           "amount": data.order.amount,
                           "currency": data.order.currency,
                            "name": "Y",
                            "description": "Reorder",
                            "order_id": data.order.id,
                            "handler": function(response){
                                handlePaymentSuccess(response,orderId);
                            },
                        //    "prefill":{
                        //         name: '<%# =checkOut.address.username%>',
                        //         email: '<%# =checkOut.address.email%>',
                        //     },
                            "theme": {
                                color: "#3399cc"
                            }
                        };
                        const rzp1 = new Razorpay(options);
                        rzp1.open();
                    }else{
                        Swal.fire('Error!', data.message, 'error');
                    }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire(
                    'Error!',
                    'An error occurred while processing your request.',
                    'error'
                );
            });
    }})
    }

	function handlePaymentSuccess(response,orderId){
        console.log("handlePaymentSuccess >>> ",response);
        fetch('/handleReorderPayment',{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                orderId: orderId,
                razorpayPaymentId: response.razorpay_payment_id,
                razorpayOrderId: response.razorpay_order_id,
                razorpaySignature: response.razorpay_signature
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("handlePaymentSuccess >>> ",data);
            if(data.success){
                Swal.fire('Success!', 'Your order has been reordered.', 'success')
                .then(() => {
                    window.location.href = data.redirectUrl;
                })
            }else{
                Swal.fire('Error!', data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire(
                'Error!',
                'An error occurred while processing your request.',
                'error'
            );
        })
            
    }



     
    </script>
</body>
</html>
